- become: yes
  block:
    - name: Create web directory
      file:
        path: "{{ ara_server_www_dir }}"
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: Collect static files
      environment:
        ARA_SETTINGS: "{{ ara_server_settings }}"
        PATH: "{{ path_with_virtualenv | default(omit) }}"
      command: ara-manage collectstatic --clear --no-input

    - name: Install nginx
      package:
        name: nginx
        state: present

    - name: Set selinux boolean to allow nginx to reverse proxy
      seboolean:
        name: httpd_can_network_connect
        state: yes
        persistent: yes
      when: ansible_os_family == "RedHat"

    - name: Set up the nginx vhost
      template:
        src: nginx_vhost.conf.j2
        dest: "{{ ara_server_nginx_config_path }}/ara.conf"
      notify:
        - restart nginx

    - name: Enable the nginx configuration on Debian-like systems
      file:
        src: "{{ ara_server_nginx_config_path }}/ara.conf"
        dest: /etc/nginx/sites-enabled/ara.conf
        state: link
      when: ansible_os_family == 'Debian'
      notify:
        - restart nginx

    - name: Enable and start nginx
      service:
        name: nginx
        state: started
        enabled: yes
      register: ara_server_nginx_enabled
